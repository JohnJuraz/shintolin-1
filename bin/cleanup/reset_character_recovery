#!/usr/bin/env node_modules/coffee-script/bin/coffee

require 'babel/register'

db = require '../../db'
db.connect().then ->

  async = require 'async'
  queries = require '../../queries'

  fail = (err) ->
    console.error err
    process.exit 1

  query =
    building:
      $exists: true

  db.tiles().find(query).toArray (err, tiles) ->
    return fail(err) if err?
    console.log "#{tiles.length} tiles with buildings"

    async.forEachOfSeries tiles, (t, i, cb) ->
      async.forEachOfSeries t.people ? [], (c, j, cb) ->
        recovery = queries.calculate_recovery c, t
        console.log recovery
        db.characters().updateOne {_id: c._id},
          $set:
            recovery: recovery
        , cb
      , cb
    , (err) ->
      return fail(err) if err?
      process.exit 0
